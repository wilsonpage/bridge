(function(q){"object"===typeof exports&&"undefined"!==typeof module?module.exports=q():"function"===typeof define&&define.amd?define([],q):("undefined"!==typeof window?window:"undefined"!==typeof global?global:"undefined"!==typeof self?self:this).bridge=q()})(function(){return function d(l,g,e){function k(f,n){if(!g[f]){if(!l[f]){var c="function"==typeof require&&require;if(!n&&c)return c(f,!0);if(m)return m(f,!0);c=Error("Cannot find module '"+f+"'");throw c.code="MODULE_NOT_FOUND",c;}c=g[f]={exports:{}};
l[f][0].call(c.exports,function(a){var b=l[f][1][a];return k(b?b:a)},c,c.exports,d,l,g,e)}return g[f].exports}for(var m="function"==typeof require&&require,f=0;f<e.length;f++)k(e[f]);return k}({1:[function(d,l,g){var e=l.exports=self.bridge||{};e.client=d("../src/client");"u"!="undefined"[0]?(void 0)([],function(){return e}):self.bridge=e},{"../src/client":2}],2:[function(d,l,g){function e(a,b,h){if(!(this instanceof e))return new e(a,b,h);"object"==typeof a&&(b=a.endpoint,h=a.timeout,a=a.service);
this.id=n();this.service=a;this.timeout=h;this.endpoint=b||this.endpoint;if(!this.endpoint)throw k(1);this.setPort(this.endpoint);this.pending=new Set;this.receiver=p.receiver(this.id).on("_push",this.onPush.bind(this));c("initialized",a)}function k(a,b){b=[].slice.call(arguments,1);return Error({1:"an endpoint must be defined",2:'Unable to establish a connection with "'+b[0]+'". Either the target endpoint is not alive or the Service is not `.listen()`ing.',3:'Method "'+b[0]+"\" didn't get a response. Either the target endpoint is not alive or the Service is not `.listen()`ing."}[a])}
var m=d("./message/port-adaptors"),f=d("./emitter"),p=d("./message"),n=d("./utils").uuid;l.exports=e;var c={0:function(){},1:function(a){return performance.mark("[Client] - "+a)},2:function(a,b){b=[].slice.call(arguments,1);console.log.apply(console,[].concat(["[Client]"+("["+self.constructor.name+"]["+location.pathname+"]")+' - "'+a+'"'],b))}}[1];e.prototype={connect:function(){var a=this;c("connect");if(this.connected)return this.connected;c("connecting...",this.service);var b=new MessageChannel;
this.channel=b.port1;this.channel.start();var h={clientId:this.id,service:this.service};return this.connected=this.message("_connect").set("transfer",[b.port2]).set("data",h).listen(b.port1).send().then(function(b){c("connected",b);b.event.target===a.channel?a.setPort(a.channel):(a.channel.close(),delete a.channel);a.receiver.listen(a.port)}).catch(function(b){"timeout"==(b&&b.message)&&(b=k(2,a.service),console.error(b.message));throw b;})},disconnect:function(a){var b=this;if(!this.connected)return Promise.resolve();
c("disconnecting ...");a={noRespond:a&&a.noRespond,data:this.id};this.cancelPending();return this.message("_disconnect").set(a).send().then(function(){return b.onDisconnected()})},method:function(a,b){var h=this;b=[].slice.call(arguments,1);return this.connect().then(function(){c("method",a);return h.message("_method").set({recipient:h.service,data:{name:a,args:b}}).send()}).then(function(a){return a.value}).catch(function(b){"timeout"==(b&&b.message)&&(b=k(3,a),console.error(b.message));throw b;
})},plugin:function(a){a(this,{Emitter:f,uuid:n});return this},message:function(a){var b=this;c("create message",a);var h=p(a).set("port",this.port).set("timeout",this.timeout).on("response",function(){return b.pending.delete(h)}).on("cancel",function(){return b.pending.delete(h)});this.pending.add(h);return h},cancelPending:function(){c("cancel pending");this.pending.forEach(function(a){a.cancel()});this.pending.clear()},pendingResponded:function(){var a=[];this.pending.forEach(function(b){return a.push(b.responded)});
return Promise.all(a)},onPush:function(a){c("on push",a.data);this._emit(a.data.type,a.data.data)},onDisconnected:function(){var a=this;delete this.connected;this.pendingResponded().then(function(){c("disconnected");a.channel&&a.channel.close();a._emit("disconnected")})},setPort:function(a){c("set port");this.port=m(a)},destroy:function(){var a=this;return this.disconnect().then(function(){a.destroyed||(c("destroy"),a.destroyed=!0,a.receiver.destroy(),a._off(),a.port=a.endpoint=a.receiver=null)})},
_on:f.prototype.on,_off:f.prototype.off,_emit:f.prototype.emit};e.prototype.on=function(a,b){var h=this;this.connect().then(function(){c("bind on",a);f.prototype.on.call(h,a,b);h.message("_on").set("noRespond",!0).set("data",{name:a,clientId:h.id}).send(h.port)});return this};e.prototype.off=function(a,b){var c=this;this.connect().then(function(){f.prototype.off.call(c,a,b);c.message("_off").set("noRespond",!0).set("data",{name:a,clientId:c.id}).send(c.port)});return this};d=e.prototype;d.destroy=
d.destroy;d.plugin=d.plugin;d.method=d.method;d.connect=d.connect;d.disconnect=d.disconnect;d.on=d.on;d.off=d.off},{"./emitter":3,"./message":4,"./message/port-adaptors":5,"./utils":6}],3:[function(d,l,g){function e(d){if(d)return Object.assign(d,e.prototype)}l.exports=e;e.prototype={on:function(d,e){this._callbacks||(this._callbacks={});this._callbacks[d]||(this._callbacks[d]=[]);this._callbacks[d].push(e);return this},off:function(d,e){if(this._callbacks)switch(arguments.length){case 0:this._callbacks=
{};break;case 1:delete this._callbacks[d];break;default:var f=this._callbacks[d];if(!f)return;var g=f.indexOf(e);~g&&f.splice(g,1)}return this},emit:function(d,e){if(this._callbacks)for(var f=this._callbacks[d]||[],f=f.concat(this._callbacks["*"]||[]),g=0;g<f.length;g++)f[g].call(this,e,d);return this}};d=e.prototype;d.off=d.off;d.on=d.on},{}],4:[function(d,l,g){function e(a){this.cancelled=!1;this.listeners=[];this.deferred=n();this.onMessage=this.onMessage.bind(this);this.onTimeout=this.onTimeout.bind(this);
"object"===typeof a?this.setupInbound(a):this.setupOutbound(a)}function k(a){this.name=a;this.ports=new Set;this.onMessage=this.onMessage.bind(this);this.listen=this.listen.bind(this);this.unlisten=this.unlisten.bind(this)}function m(a,b){b=[].slice.call(arguments,1);return Error({1:".send() can only be called once",2:"response already sent for this message",3:"a port must be defined",4:"timeout"}[a])}var f=d("./port-adaptors"),p=d("../emitter");d=d("../utils");var n=d.deferred,c=d.uuid;g=l.exports=
function(a){return new e(a)};g.receiver=function(a,b){return new k(a,b)};g.Receiver=k;g.Message=e;e.prototype={setupOutbound:function(a){this.id=c();this.type=a;this.sent=!1;this.recipient="*"},setupInbound:function(a){this.hasResponded=!1;this.setSourcePort(a.source||a.target);this.event=a;Object.assign(this,a.data)},setSourcePort:function(a){this.sourcePort=f(a,{ready:!0});return this},set:function(a,b){"object"==typeof a?Object.assign(this,a):this[a]=b;return this},serialize:function(){return{id:this.id,
type:this.type,data:this.data,recipient:this.recipient,noRespond:this.noRespond}},preventDefault:function(){this.defaultPrevented=!0},send:function(a){if(this.sent)throw m(1);var b=this.serialize(),c=!this.noRespond;this.port=a?f(a):this.port;if(!this.port)throw m(3);c?(this.listen(this.port),this.setResponseTimeout()):this.deferred.resolve();this.port.postMessage(b,this.getTransfer());return this.deferred.promise},setResponseTimeout:function(){!1!==this.timeout&&(this._timer=setTimeout(this.onTimeout,
this.timeout||1E3))},clearResponseTimeout:function(){clearTimeout(this._timer)},getTransfer:function(){return this.transfer||this.event&&this.event.ports},onMessage:function(a){if(a.data.response&&a.data.id===this.id&&!this.cancelled)this.onResponse(a)},onTimeout:function(){this.silentTimeout||this.deferred.reject(m(4));this.teardown()},listen:function(a){a=f(a);a.addListener(this.onMessage);this.listeners.push(a);return this},unlisten:function(){var a=this;this.listeners.forEach(function(b){return b.removeListener(a.onMessage)});
this.listeners=[]},cancel:function(){this.teardown();this.cancelled=!0;this.emit("cancel")},teardown:function(){this.clearResponseTimeout();this.unlisten()},respond:function(a){function b(a){d({type:"resolve",value:a})}function c(a){d({type:"reject",value:a&&a.message||a})}function d(a){e.response=a;e.sourcePort.postMessage({id:e.id,response:a},e.transfer)}if(this.hasResponded)throw m(2);if(this.sourcePort&&!this.noRespond){var e=this;this.hasResponded=!0;a instanceof Error&&c(a);Promise.resolve(a).then(b,
c).catch(c)}},forward:function(a){var b=this;return this.set("silentTimeout",!0).send(a).then(function(a){return b.respond(a.value)})},onResponse:function(a){var b=a.data.response,c="reject"==b.type?b.value:b;b.event=a;this.response=b;this.teardown();this.deferred[this.response.type](c);this.emit("response",b)}};p(e.prototype);k.prototype={listen:function(a){a=f(a||self,{receiver:!0});if(!this.ports.has(a))return a.addListener(this.onMessage,this.listen),this.ports.add(a),this},unlisten:function(){var a=
this;this.ports.forEach(function(b){b.removeListener(a.onMessage,a.unlisten)})},onMessage:function(a){if(a.data.id&&a.data.type&&this.isRecipient(a.data.recipient)&&(a=new e(a),this.emit("message",a),!a.defaultPrevented))try{this.emit(a.type,a)}catch(b){throw a.respond(b),b;}},isRecipient:function(a){return a==this.name||"*"==a||"*"==this.name},destroy:function(){this.unlisten();delete this.name;return this}};p(k.prototype)},{"../emitter":3,"../utils":6,"./port-adaptors":5}],5:[function(d,l,g){function e(c){this.target=
c}function k(c,a,b){c.addEventListener(a,b)}var m=d("../utils").deferred;l.exports=function(c,a){if(!c)throw Error({1:"target is undefined"}[1]);if(c&&c.addListener)return c;var b=p[c.constructor.name];return b?b(c,a):new e(c,a)};var f=e.prototype={constructor:e,addListener:function(c){this.target.addEventListener("message",c)},removeListener:function(c){this.target.removeEventListener("message",c)},postMessage:function(c,a){this.target.postMessage(c,a)}},p={HTMLIFrameElement:function(c){var a=n(c);
return{addListener:function(a,c){window.addEventListener("message",a)},removeListener:function(a,c){window.removeEventListener("message",a)},postMessage:function(b,d){a.then(function(){c.contentWindow.postMessage(b,"*",d)})}}},BroadcastChannel:function(c,a){function b(){var a=m();c.postMessage("ready?");k(c,"message",function r(b){"ready"==b.data&&(c.removeEventListener("message",r),a.resolve())});return a.promise}var d=a&&a.receiver,e=a&&a.ready,e=e||d?Promise.resolve():b();d&&(c.postMessage("ready"),
k(c,"message",function(a){"ready?"==a.data&&c.postMessage("ready")}));return{target:c,addListener:f.addListener,removeListener:f.removeListener,postMessage:function(a,b){e.then(function(){return c.postMessage(a,b)})}}},Window:function(c,a){var b=a&&a.ready||c===self,b=b?Promise.resolve():n(c);return{addListener:function(a,b){window.addEventListener("message",a)},removeListener:function(a,b){window.removeEventListener("message",a)},postMessage:function(a,d){b.then(function(){return c.postMessage(a,
"*",d)})}}},SharedWorker:function(c){c.port.start();return new e(c.port)},SharedWorkerGlobalScope:function(){var c=[];return{postMessage:function(){},addListener:function(a,b){this.onconnect=function(a){a=a.ports[0];c.push(a);a.start();b(a)};self.addEventListener("connect",this.onconnect)},removeListener:function(a,b){self.removeEventListener("connect",this.onconnect);c.forEach(function(a){a.close();b(a)})}}}},n=function(){if("undefined"!=typeof window){var c=window.opener||window.parent,a=new WeakSet;
c!=self&&k(window,"DOMContentLoaded",function h(){window.removeEventListener("DOMContentLoaded",h);c.postMessage("load","*")});k(self,"message",function(c){return"load"==c.data&&a.add(c.source)});return function(c){var d=c.contentWindow||c;if(a.has(d)||d==window.parent)return Promise.resolve();var e=m();k(window,"message",function r(a){"load"==a.data&&a.source==d&&(window.removeEventListener("message",r),e.resolve())});return e.promise}}}()},{"../utils":6}],6:[function(d,l,g){g.uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,
function(d){var g=16*Math.random()|0;return("x"==d?g:g&3|8).toString(16)})};g.deferred=function(){var d={};d.promise=new Promise(function(g,l){d.resolve=g;d.reject=l});return d}},{}]},{},[1])(1)});
