(function(q){"object"===typeof exports&&"undefined"!==typeof module?module.exports=q():"function"===typeof define&&define.amd?define([],q):("undefined"!==typeof window?window:"undefined"!==typeof global?global:"undefined"!==typeof self?self:this).bridge=q()})(function(){return function d(l,h,f){function k(g,n){if(!h[g]){if(!l[g]){var c="function"==typeof require&&require;if(!n&&c)return c(g,!0);if(m)return m(g,!0);c=Error("Cannot find module '"+g+"'");throw c.code="MODULE_NOT_FOUND",c;}c=h[g]={exports:{}};
l[g][0].call(c.exports,function(b){var a=l[g][1][b];return k(a?a:b)},c,c.exports,d,l,h,f)}return h[g].exports}for(var m="function"==typeof require&&require,g=0;g<f.length;g++)k(f[g]);return k}({1:[function(d,l,h){var f=l.exports=self.bridge||{};f.client=d("../src/client");"u"!="undefined"[0]?(void 0)([],function(){return f}):self.bridge=f},{"../src/client":2}],2:[function(d,l,h){function f(b,a,e){if(!(this instanceof f))return new f(b,a,e);"object"==typeof b&&(a=b.endpoint,e=b.timeout,b=b.service);
this.id=n();this.service=b;this.timeout=e;this.endpoint=a||this.endpoint;if(!this.endpoint)throw k(1);this.setPort(this.endpoint);this.pending=new Set;this.receiver=p.receiver(this.id).on("_push",this.onPush.bind(this));c("initialized",b)}function k(b,a){a=[].slice.call(arguments,1);return Error({1:"an endpoint must be defined",2:'Unable to establish a connection with "'+a[0]+'". Either the target endpoint is not alive or the Service is not `.listen()`ing.',3:'Method "'+a[0]+"\" didn't get a response. Either the target endpoint is not alive or the Service is not `.listen()`ing."}[b])}
var m=d("./message/port-adaptors"),g=d("./emitter"),p=d("./message"),n=d("./utils").uuid;l.exports=f;var c={0:function(){},1:function(b){return performance.mark("["+self.constructor.name+"][Client] - "+b)},2:function(b,a){a=[].slice.call(arguments,1);console.log.apply(console,[].concat(["[Client]"+("["+self.constructor.name+"]["+location.pathname+"]")+' - "'+b+'"'],a))}}[1];f.prototype={connect:function(){var b=this;c("connect");if(this.connected)return this.connected;c("connecting...",this.service);
var a=new MessageChannel;this.channel=a.port1;this.channel.start();var e={clientId:this.id,service:this.service};return this.connected=this.message("_connect").set("transfer",[a.port2]).set("data",e).listen(a.port1).send().then(function(a){c("connected",a);a.event.target===b.channel?b.setPort(b.channel):(b.channel.close(),delete b.channel);b.receiver.listen(b.port)}).catch(function(a){"timeout"==(a&&a.message)&&(a=k(2,b.service),console.error(a.message));throw a;})},disconnect:function(b){var a=this;
if(!this.connected)return Promise.resolve();c("disconnecting ...");b={noRespond:b&&b.noRespond,data:this.id};this.cancelPending();return this.message("_disconnect").set(b).send().then(function(){return a.onDisconnected()})},method:function(b,a){var e=this;a=[].slice.call(arguments,1);return this.connect().then(function(){c("method",b);return e.message("_method").set({recipient:e.service,data:{name:b,args:a}}).send()}).then(function(a){return a.value}).catch(function(a){"timeout"==(a&&a.message)&&
(a=k(3,b),console.error(a.message));throw a;})},plugin:function(b){b(this,{Emitter:g,uuid:n});return this},message:function(b){var a=this;c("create message",b);var e=p(b).set("port",this.port).set("timeout",this.timeout).on("response",function(){return a.pending.delete(e)}).on("cancel",function(){return a.pending.delete(e)});this.pending.add(e);return e},cancelPending:function(){c("cancel pending");this.pending.forEach(function(b){b.cancel()});this.pending.clear()},pendingResponded:function(){var b=
[];this.pending.forEach(function(a){return b.push(a.responded)});return Promise.all(b)},onPush:function(b){c("on push",b.data);this._emit(b.data.type,b.data.data)},onDisconnected:function(){var b=this;delete this.connected;this.pendingResponded().then(function(){c("disconnected");b.channel&&b.channel.close();b._emit("disconnected")})},setPort:function(b){c("set port");this.port=m(b)},destroy:function(){var b=this;return this.disconnect().then(function(){b.destroyed||(c("destroy"),b.destroyed=!0,b.receiver.destroy(),
b._off(),b.port=b.endpoint=b.receiver=null)})},_on:g.prototype.on,_off:g.prototype.off,_emit:g.prototype.emit};f.prototype.on=function(b,a){var e=this;this.connect().then(function(){c("bind on",b);g.prototype.on.call(e,b,a);e.message("_on").set("noRespond",!0).set("data",{name:b,clientId:e.id}).send(e.port)});return this};f.prototype.off=function(b,a){var e=this;this.connect().then(function(){g.prototype.off.call(e,b,a);e.message("_off").set("noRespond",!0).set("data",{name:b,clientId:e.id}).send(e.port)});
return this};d=f.prototype;d.destroy=d.destroy;d.plugin=d.plugin;d.method=d.method;d.connect=d.connect;d.disconnect=d.disconnect;d.on=d.on;d.off=d.off},{"./emitter":3,"./message":4,"./message/port-adaptors":5,"./utils":6}],3:[function(d,l,h){function f(d){if(d)return Object.assign(d,f.prototype)}l.exports=f;f.prototype={on:function(d,f){this._callbacks||(this._callbacks={});this._callbacks[d]||(this._callbacks[d]=[]);this._callbacks[d].push(f);return this},off:function(d,f){if(this._callbacks)switch(arguments.length){case 0:this._callbacks=
{};break;case 1:delete this._callbacks[d];break;default:var g=this._callbacks[d];if(!g)return;var h=g.indexOf(f);~h&&g.splice(h,1)}return this},emit:function(d,f){if(this._callbacks)for(var g=this._callbacks[d]||[],g=g.concat(this._callbacks["*"]||[]),h=0;h<g.length;h++)g[h].call(this,f,d);return this}};d=f.prototype;d.off=d.off;d.on=d.on},{}],4:[function(d,l,h){function f(a){this.cancelled=!1;this.listeners=[];this.deferred=n();this.onMessage=this.onMessage.bind(this);this.onTimeout=this.onTimeout.bind(this);
"object"===typeof a?this.setupInbound(a):this.setupOutbound(a);b("initialized",a)}function k(a){this.name=a;this.ports=new Set;this.onMessage=this.onMessage.bind(this);this.listen=this.listen.bind(this);this.unlisten=this.unlisten.bind(this);b("receiver initialized",a)}function m(a,b){b=[].slice.call(arguments,1);return Error({1:".send() can only be called once",2:"response already sent for this message",3:"a port must be defined",4:"timeout"}[a])}var g=d("./port-adaptors"),p=d("../emitter");d=d("../utils");
var n=d.deferred,c=d.uuid;h=l.exports=function(a){return new f(a)};h.receiver=function(a,b){return new k(a,b)};h.Receiver=k;h.Message=f;var b={0:function(){},1:function(a){return performance.mark("["+self.constructor.name+"][Message] - "+a)},2:function(a,b){b=[].slice.call(arguments,1);console.log.apply(console,[].concat(["[Message]"+("["+self.constructor.name+"]["+location.pathname+"]")+' - "'+a+'"'],b))}}[1];f.prototype={setupOutbound:function(a){this.id=c();this.type=a;this.sent=!1;this.recipient=
"*"},setupInbound:function(a){b("inbound");this.hasResponded=!1;this.setSourcePort(a.source||a.target);this.event=a;Object.assign(this,a.data)},setSourcePort:function(a){b("set source",a.constructor.name);this.sourcePort=g(a,{ready:!0});return this},set:function(a,e){b("set",a,e);"object"==typeof a?Object.assign(this,a):this[a]=e;return this},serialize:function(){return{id:this.id,type:this.type,data:this.data,recipient:this.recipient,noRespond:this.noRespond}},preventDefault:function(){b("prevent default");
this.defaultPrevented=!0},send:function(a){b("send",this.type);if(this.sent)throw m(1);var e=this.serialize(),c=!this.noRespond;this.port=a?g(a):this.port;if(!this.port)throw m(3);c?(this.listen(this.port),this.setResponseTimeout()):this.deferred.resolve();this.port.postMessage(e,this.getTransfer());b("sent",e);return this.deferred.promise},setResponseTimeout:function(){!1!==this.timeout&&(this._timer=setTimeout(this.onTimeout,this.timeout||1E3))},clearResponseTimeout:function(){clearTimeout(this._timer)},
getTransfer:function(){return this.transfer||this.event&&this.event.ports},onMessage:function(a){if(a.data.response&&a.data.id===this.id&&!this.cancelled)this.onResponse(a)},onTimeout:function(){b("response timeout",this.type);this.silentTimeout||this.deferred.reject(m(4));this.teardown()},listen:function(a){b("add response listener",a);a=g(a);a.addListener(this.onMessage);this.listeners.push(a);return this},unlisten:function(){var a=this;b("remove response listeners");this.listeners.forEach(function(b){return b.removeListener(a.onMessage)});
this.listeners=[]},cancel:function(){this.teardown();this.cancelled=!0;this.emit("cancel")},teardown:function(){this.clearResponseTimeout();this.unlisten()},respond:function(a){function e(a){b("resolve",a);d({type:"resolve",value:a})}function c(a){a=a&&a.message||a;b("reject",a);d({type:"reject",value:a})}function d(a){f.response=a;f.sourcePort.postMessage({id:f.id,response:a},f.transfer);b("responded with:",a)}b("respond",a);if(this.hasResponded)throw m(2);if(this.sourcePort&&!this.noRespond){var f=
this;this.hasResponded=!0;a instanceof Error&&c(a);Promise.resolve(a).then(e,c).catch(c)}},forward:function(a){var e=this;b("forward");return this.set("silentTimeout",!0).send(a).then(function(a){return e.respond(a.value)})},onResponse:function(a){b("on response",a.data);var e=a.data.response,c="reject"==e.type?e.value:e;e.event=a;this.response=e;this.teardown();this.deferred[this.response.type](c);this.emit("response",e)}};p(f.prototype);k.prototype={listen:function(a){b("listen");a=g(a||self,{receiver:!0});
if(!this.ports.has(a))return a.addListener(this.onMessage,this.listen),this.ports.add(a),this},unlisten:function(){var a=this;b("unlisten");this.ports.forEach(function(b){b.removeListener(a.onMessage,a.unlisten)})},onMessage:function(a){if(a.data.id&&a.data.type&&this.isRecipient(a.data.recipient)&&(b("receiver on message",a.data),a=new f(a),this.emit("message",a),!a.defaultPrevented))try{this.emit(a.type,a)}catch(c){throw a.respond(c),c;}},isRecipient:function(a){return a==this.name||"*"==a||"*"==
this.name},destroy:function(){this.unlisten();delete this.name;return this}};p(k.prototype)},{"../emitter":3,"../utils":6,"./port-adaptors":5}],5:[function(d,l,h){function f(c){this.target=c}function k(c,b,a){c.addEventListener(b,a)}var m=d("../utils").deferred;l.exports=function(c,b){if(!c)throw Error({1:"target is undefined"}[1]);if(c&&c.addListener)return c;var a=p[c.constructor.name];return a?a(c,b):new f(c,b)};var g=f.prototype={constructor:f,addListener:function(c){this.target.addEventListener("message",
c)},removeListener:function(c){this.target.removeEventListener("message",c)},postMessage:function(c,b){this.target.postMessage(c,b)}},p={HTMLIFrameElement:function(c){var b=n(c);return{addListener:function(a,b){window.addEventListener("message",a)},removeListener:function(a,b){window.removeEventListener("message",a)},postMessage:function(a,e){b.then(function(){c.contentWindow.postMessage(a,"*",e)})}}},BroadcastChannel:function(c,b){function a(){var a=m();c.postMessage("ready?");k(c,"message",function r(b){"ready"==
b.data&&(c.removeEventListener("message",r),a.resolve())});return a.promise}var e=b&&b.receiver,d=b&&b.ready,d=d||e?Promise.resolve():a();e&&(c.postMessage("ready"),k(c,"message",function(a){"ready?"==a.data&&c.postMessage("ready")}));return{target:c,addListener:g.addListener,removeListener:g.removeListener,postMessage:function(a,b){d.then(function(){return c.postMessage(a,b)})}}},Window:function(c,b){var a=b&&b.ready||c===self,a=a?Promise.resolve():n(c);return{addListener:function(a,b){window.addEventListener("message",
a)},removeListener:function(a,b){window.removeEventListener("message",a)},postMessage:function(b,d){a.then(function(){return c.postMessage(b,"*",d)})}}},SharedWorker:function(c){c.port.start();return new f(c.port)},SharedWorkerGlobalScope:function(){var c=[];return{postMessage:function(){},addListener:function(b,a){this.onconnect=function(b){b=b.ports[0];c.push(b);b.start();a(b)};self.addEventListener("connect",this.onconnect)},removeListener:function(b,a){self.removeEventListener("connect",this.onconnect);
c.forEach(function(b){b.close();a(b)})}}}},n=function(){if("undefined"!=typeof window){var c=window.opener||window.parent,b=new WeakSet;c!=self&&k(window,"DOMContentLoaded",function e(){window.removeEventListener("DOMContentLoaded",e);c.postMessage("load","*")});k(self,"message",function(c){return"load"==c.data&&b.add(c.source)});return function(c){var d=c.contentWindow||c;if(b.has(d)||d==window.parent)return Promise.resolve();var f=m();k(window,"message",function r(b){"load"==b.data&&b.source==d&&
(window.removeEventListener("message",r),f.resolve())});return f.promise}}}()},{"../utils":6}],6:[function(d,l,h){h.uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(d){var h=16*Math.random()|0;return("x"==d?h:h&3|8).toString(16)})};h.deferred=function(){var d={};d.promise=new Promise(function(h,l){d.resolve=h;d.reject=l});return d}},{}]},{},[1])(1)});
