(function(p){"object"===typeof exports&&"undefined"!==typeof module?module.exports=p():"function"===typeof define&&define.amd?define([],p):("undefined"!==typeof window?window:"undefined"!==typeof global?global:"undefined"!==typeof self?self:this).bridge=p()})(function(){return function f(h,m,d){function l(e,c){if(!m[e]){if(!h[e]){var b="function"==typeof require&&require;if(!c&&b)return b(e,!0);if(n)return n(e,!0);b=Error("Cannot find module '"+e+"'");throw b.code="MODULE_NOT_FOUND",b;}b=m[e]={exports:{}};
h[e][0].call(b.exports,function(b){var a=h[e][1][b];return l(a?a:b)},b,b.exports,f,h,m,d)}return m[e].exports}for(var n="function"==typeof require&&require,g=0;g<d.length;g++)l(d[g]);return l}({1:[function(f,h,m){var d=h.exports=self.bridge||{};d.service=f("../src/service");"u"!="undefined"[0]?(void 0)([],function(){return d}):self.bridge=d},{"../src/service":5}],2:[function(f,h,m){function d(l){if(l)return Object.assign(l,d.prototype)}h.exports=d;d.prototype={on:function(d,f){this._callbacks||(this._callbacks=
{});this._callbacks[d]||(this._callbacks[d]=[]);this._callbacks[d].push(f);return this},off:function(d,f){if(this._callbacks)switch(arguments.length){case 0:this._callbacks={};break;case 1:delete this._callbacks[d];break;default:var g=this._callbacks[d];if(!g)return;var e=g.indexOf(f);~e&&g.splice(e,1)}return this},emit:function(d,f){if(this._callbacks)for(var g=this._callbacks[d]||[],g=g.concat(this._callbacks["*"]||[]),e=0;e<g.length;e++)g[e].call(this,f,d);return this}};f=d.prototype;f.off=f.off;
f.on=f.on},{}],3:[function(f,h,m){function d(a){this.cancelled=!1;this.listeners=[];this.deferred=c();this.onMessage=this.onMessage.bind(this);this.onTimeout=this.onTimeout.bind(this);"object"===typeof a?this.setupInbound(a):this.setupOutbound(a);k("initialized",a)}function l(a){this.name=a;this.ports=new Set;this.onMessage=this.onMessage.bind(this);this.listen=this.listen.bind(this);this.unlisten=this.unlisten.bind(this);k("receiver initialized",a)}function n(a,b){b=[].slice.call(arguments,1);return Error({1:".send() can only be called once",
2:"response already sent for this message",3:"a port must be defined",4:"timeout"}[a])}var g=f("./port-adaptors"),e=f("../emitter");f=f("../utils");var c=f.deferred,b=f.uuid;m=h.exports=function(a){return new d(a)};m.receiver=function(a,b){return new l(a,b)};m.Receiver=l;m.Message=d;var k={0:function(){},1:function(a){return performance.mark("["+self.constructor.name+"][Message] - "+a)},2:function(a,b){b=[].slice.call(arguments,1);console.log.apply(console,[].concat(["[Message]"+("["+self.constructor.name+
"]["+location.pathname+"]")+' - "'+a+'"'],b))}}[1];d.prototype={setupOutbound:function(a){this.id=b();this.type=a;this.sent=!1;this.recipient="*"},setupInbound:function(a){k("inbound");this.hasResponded=!1;this.setSourcePort(a.source||a.target);this.event=a;Object.assign(this,a.data)},setSourcePort:function(a){k("set source",a.constructor.name);this.sourcePort=g(a,{ready:!0});return this},set:function(a,b){k("set",a,b);"object"==typeof a?Object.assign(this,a):this[a]=b;return this},serialize:function(){return{id:this.id,
type:this.type,data:this.data,recipient:this.recipient,noRespond:this.noRespond}},preventDefault:function(){k("prevent default");this.defaultPrevented=!0},send:function(a){k("send",this.type);if(this.sent)throw n(1);var b=this.serialize(),c=!this.noRespond;this.port=a?g(a):this.port;if(!this.port)throw n(3);c?(this.listen(this.port),this.setResponseTimeout()):this.deferred.resolve();this.port.postMessage(b,this.getTransfer());k("sent",b);return this.deferred.promise},setResponseTimeout:function(){!1!==
this.timeout&&(this._timer=setTimeout(this.onTimeout,this.timeout||1E3))},clearResponseTimeout:function(){clearTimeout(this._timer)},getTransfer:function(){return this.transfer||this.event&&this.event.ports},onMessage:function(a){if(a.data.response&&a.data.id===this.id&&!this.cancelled)this.onResponse(a)},onTimeout:function(){k("response timeout",this.type);this.silentTimeout||this.deferred.reject(n(4));this.teardown()},listen:function(a){k("add response listener",a);a=g(a);a.addListener(this.onMessage);
this.listeners.push(a);return this},unlisten:function(){var a=this;k("remove response listeners");this.listeners.forEach(function(b){return b.removeListener(a.onMessage)});this.listeners=[]},cancel:function(){this.teardown();this.cancelled=!0;this.emit("cancel")},teardown:function(){this.clearResponseTimeout();this.unlisten()},respond:function(a){function b(a){k("resolve",a);d({type:"resolve",value:a})}function c(a){a=a&&a.message||a;k("reject",a);d({type:"reject",value:a})}function d(a){e.response=
a;e.sourcePort.postMessage({id:e.id,response:a},e.transfer);k("responded with:",a)}k("respond",a);if(this.hasResponded)throw n(2);if(this.sourcePort&&!this.noRespond){var e=this;this.hasResponded=!0;a instanceof Error&&c(a);Promise.resolve(a).then(b,c).catch(c)}},forward:function(a){var b=this;k("forward");return this.set("silentTimeout",!0).send(a).then(function(a){return b.respond(a.value)})},onResponse:function(a){k("on response",a.data);var b=a.data.response,c="reject"==b.type?b.value:b;b.event=
a;this.response=b;this.teardown();this.deferred[this.response.type](c);this.emit("response",b)}};e(d.prototype);l.prototype={listen:function(a){k("listen");a=g(a||self,{receiver:!0});if(!this.ports.has(a))return a.addListener(this.onMessage,this.listen),this.ports.add(a),this},unlisten:function(){var a=this;k("unlisten");this.ports.forEach(function(b){b.removeListener(a.onMessage,a.unlisten)})},onMessage:function(a){if(a.data.id&&a.data.type&&this.isRecipient(a.data.recipient)&&(k("receiver on message",
a.data),a=new d(a),this.emit("message",a),!a.defaultPrevented))try{this.emit(a.type,a)}catch(b){throw a.respond(b),b;}},isRecipient:function(a){return a==this.name||"*"==a||"*"==this.name},destroy:function(){this.unlisten();delete this.name;return this}};e(l.prototype)},{"../emitter":2,"../utils":6,"./port-adaptors":4}],4:[function(f,h,m){function d(b){this.target=b}function l(b,c,a){b.addEventListener(c,a)}var n=f("../utils").deferred;h.exports=function(b,c){if(!b)throw Error({1:"target is undefined"}[1]);
if(b&&b.addListener)return b;var a=e[b.constructor.name];return a?a(b,c):new d(b,c)};var g=d.prototype={constructor:d,addListener:function(b){this.target.addEventListener("message",b)},removeListener:function(b){this.target.removeEventListener("message",b)},postMessage:function(b,c){this.target.postMessage(b,c)}},e={HTMLIFrameElement:function(b){var d=c(b);return{addListener:function(a,b){window.addEventListener("message",a)},removeListener:function(a,b){window.removeEventListener("message",a)},postMessage:function(a,
c){d.then(function(){b.contentWindow.postMessage(a,"*",c)})}}},BroadcastChannel:function(b,c){function a(){var a=n();b.postMessage("ready?");l(b,"message",function q(c){"ready"==c.data&&(b.removeEventListener("message",q),a.resolve())});return a.promise}var d=c&&c.receiver,e=c&&c.ready,e=e||d?Promise.resolve():a();d&&(b.postMessage("ready"),l(b,"message",function(a){"ready?"==a.data&&b.postMessage("ready")}));return{target:b,addListener:g.addListener,removeListener:g.removeListener,postMessage:function(a,
c){e.then(function(){return b.postMessage(a,c)})}}},Window:function(b,d){var a=d&&d.ready||b===self,a=a?Promise.resolve():c(b);return{addListener:function(a,b){window.addEventListener("message",a)},removeListener:function(a,b){window.removeEventListener("message",a)},postMessage:function(c,d){a.then(function(){return b.postMessage(c,"*",d)})}}},SharedWorker:function(b){b.port.start();return new d(b.port)},SharedWorkerGlobalScope:function(){var b=[];return{postMessage:function(){},addListener:function(c,
a){this.onconnect=function(c){c=c.ports[0];b.push(c);c.start();a(c)};self.addEventListener("connect",this.onconnect)},removeListener:function(c,a){self.removeEventListener("connect",this.onconnect);b.forEach(function(b){b.close();a(b)})}}}},c=function(){if("undefined"!=typeof window){var b=window.opener||window.parent,c=new WeakSet;b!=self&&l(window,"DOMContentLoaded",function r(){window.removeEventListener("DOMContentLoaded",r);b.postMessage("load","*")});l(self,"message",function(b){return"load"==
b.data&&c.add(b.source)});return function(b){var d=b.contentWindow||b;if(c.has(d)||d==window.parent)return Promise.resolve();var e=n();l(window,"message",function q(b){"load"==b.data&&b.source==d&&(window.removeEventListener("message",q),e.resolve())});return e.promise}}}()},{"../utils":6}],5:[function(f,h,m){function d(c){if(!(this instanceof d))return new d(c);g.Receiver.call(this,c);this.clients={};this.methods={};this.on("_disconnect",this.onDisconnect.bind(this)).on("_connect",this.onConnect.bind(this)).on("_method",
this.onMethod.bind(this)).on("_off",this.onOff.bind(this)).on("_on",this.onOn.bind(this));this.destroy=this.destroy.bind(this);e("initialized",c,self.createEvent)}function l(c){var b=[].slice.call(arguments,1);return Error({4:'method "'+b[0]+"\" doesn't exist"}[c])}var n=f("./utils").uuid,g=f("./message");f=g.Receiver;h.exports=d;var e={0:function(){},1:function(c){return performance.mark("["+self.constructor.name+"][Service] - "+c)},2:function(c,b){b=[].slice.call(arguments,1);console.log.apply(console,
[].concat(["[Service]"+("["+self.constructor.name+"]["+location.pathname+"]")+' - "'+c+'"'],b))}}[1];d.prototype=Object.create(f.prototype);d.prototype.method=function(c,b){this.methods[c]=b;return this};d.prototype.broadcast=function(c,b,d){var a=this;e("broadcast",c,b,d);this.eachClient(function(f){if(!d||~d.indexOf(f.id))e("broadcasting to",f.id),a.push(c,b,f.id,{noRespond:!0})});return this};d.prototype.push=function(c,b,d,a){a=a&&a.noRespond;var e=this.getClient(d);return g("_push").set({recipient:d,
noRespond:a,data:{type:c,data:b}}).send(e.port)};d.prototype.eachClient=function(c){for(var b in this.clients)c(this.clients[b])};d.prototype.getClient=function(c){return this.clients[c]};d.prototype.onConnect=function(c){e("connection attempt",c.data,this.name);var b=c.data,d=b.clientId;if(d&&b.service===this.name&&!this.clients[d]&&(this.emit("before-connect",c),!c.defaultPrevented)){if(b=(b=c.event.ports)&&b[0])c.setSourcePort(b),this.listen(b),b.start();this.addClient(d,c.sourcePort);c.respond();
this.emit("connected",d);e("connected",d)}};d.prototype.onDisconnect=function(c){var b=this.clients[c.data];b&&(this.emit("before-disconnect",c),c.defaultPrevented||(this.removeClient(b.id),c.respond(),this.emit("disconnected",b.id),e("disconnected",b.id)))};d.prototype.onMethod=function(c){e("on method",c.data);this.emit("before-method",c);if(!c.defaultPrevented){var b=c.data,d=b.name,a,f=this.methods[d];if(!f)throw l(4,d);try{a=f.apply(this,b.args)}catch(g){a=g}c.respond(a)}};d.prototype.onOn=function(c){e("on on",
c.data);this.emit("on",c.data)};d.prototype.onOff=function(c){e("on off");this.emit("off",c.data)};d.prototype.addClient=function(c,b){this.clients[c]={id:c,port:b}};d.prototype.removeClient=function(c){delete this.clients[c]};d.prototype.plugin=function(c){c(this,{uuid:n});return this};d.prototype.disconnect=function(c){this.removeClient(c.id);g("disconnect").set({recipient:c.id,noRespond:!0}).send(c.port)};d.prototype.destroy=function(){delete this.clients;this.unlisten();this.off()};h=d.prototype;
h.broadcast=h.broadcast;h.destroy=h.destroy;h.method=h.method;h.plugin=h.plugin},{"./message":3,"./utils":6}],6:[function(f,h,m){m.uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(d){var f=16*Math.random()|0;return("x"==d?f:f&3|8).toString(16)})};m.deferred=function(){var d={};d.promise=new Promise(function(f,h){d.resolve=f;d.reject=h});return d}},{}]},{},[1])(1)});
