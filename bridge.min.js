(function e$$0(h,n,c){function l(f,k){if(!n[f]){if(!h[f]){var d="function"==typeof require&&require;if(!k&&d)return d(f,!0);if(p)return p(f,!0);d=Error("Cannot find module '"+f+"'");throw d.code="MODULE_NOT_FOUND",d;}d=n[f]={exports:{}};h[f][0].call(d.exports,function(b){var a=h[f][1][b];return l(a?a:b)},d,d.exports,e$$0,h,n,c)}return n[f].exports}for(var p="function"==typeof require&&require,g=0;g<c.length;g++)l(c[g]);return l})({1:[function(e,h,n){var c={service:e("../src/service"),client:e("../src/client"),
_m:e("../src/message")};"u"!=(typeof define)[0]?define([],function(){return c}):self.bridge=c},{"../src/client":2,"../src/message":4,"../src/service":6}],2:[function(e,h,n){function c(b,a,m){if(!(this instanceof c))return new c(b,a,m);"object"==typeof b&&(a=b.endpoint,m=b.timeout,b=b.service);this.id=k();this.service=b;this.timeout=m;this.endpoint=a||this.endpoint;if(!this.endpoint)throw l(1);this.setPort(this.endpoint);this.pending=new Set;this.receiver=f.receiver(this.id).on("_push",this.onPush.bind(this));
d("initialized",b)}function l(b,a){a=[].slice.call(arguments,1);return Error({1:"an endpoint must be defined",2:'Unable to establish a connection with "'+a[0]+'". Either the target endpoint is not alive or the Service is not `.listen()`ing.',3:'Method "'+a[0]+"\" didn't get a response. Either the target endpoint is not alive or the Service is not `.listen()`ing."}[b])}var p=e("./message/port-adaptors"),g=e("./emitter"),f=e("./message"),k=e("./utils").uuid;h.exports=c;var d={0:function(){},1:function(b){return performance.mark("["+
self.constructor.name+"][Client] - "+b)},2:function(b,a){a=[].slice.call(arguments,1);console.log.apply(console,[].concat(["[Client]"+("["+self.constructor.name+"]["+location.pathname+"]")+' - "'+b+'"'],a))}}[1];c.prototype={connect:function(){var b=this;d("connect");if(this.connected)return this.connected;d("connecting...",this.service);var a=new MessageChannel;this.channel=a.port1;this.channel.start();var m={clientId:this.id,service:this.service};return this.connected=this.message("_connect").set("transfer",
[a.port2]).set("data",m).listen(a.port1).send().then(function(a){d("connected",a);a.event.target===b.channel?b.setPort(b.channel):(b.channel.close(),delete b.channel);b.receiver.listen(b.port)}).catch(function(a){"timeout"==(a&&a.message)&&(a=l(2,b.service),console.error(a.message));throw a;})},disconnect:function(b){var a=this;if(!this.connected)return Promise.resolve();d("disconnecting ...");b={noRespond:b&&b.noRespond,data:this.id};this.cancelPending();return this.message("_disconnect").set(b).send().then(function(){return a.onDisconnected()})},
method:function(b,a){var m=this;a=[].slice.call(arguments,1);return this.connect().then(function(){d("method",b);return m.message("_method").set({recipient:m.service,data:{name:b,args:a}}).send()}).then(function(a){return a.value}).catch(function(a){"timeout"==(a&&a.message)&&(a=l(3,b),console.error(a.message));throw a;})},plugin:function(b){b(this,{Emitter:g,uuid:k});return this},message:function(b){var a=this;d("create message",b);var m=f(b).set("port",this.port).set("timeout",this.timeout).on("response",
function(){return a.pending.delete(m)}).on("cancel",function(){return a.pending.delete(m)});this.pending.add(m);return m},cancelPending:function(){d("cancel pending");this.pending.forEach(function(b){b.cancel()});this.pending.clear()},pendingResponded:function(){var b=[];this.pending.forEach(function(a){return b.push(a.responded)});return Promise.all(b)},onPush:function(b){d("on push",b.data);this._emit(b.data.type,b.data.data)},onDisconnected:function(){var b=this;delete this.connected;this.pendingResponded().then(function(){d("disconnected");
b.channel&&b.channel.close();b._emit("disconnected")})},setPort:function(b){d("set port");this.port=p(b)},destroy:function(){var b=this;return this.disconnect().then(function(){b.destroyed||(d("destroy"),b.destroyed=!0,b.receiver.destroy(),b._off(),b.port=b.endpoint=b.receiver=null)})},_on:g.prototype.on,_off:g.prototype.off,_emit:g.prototype.emit};c.prototype.on=function(b,a){var m=this;this.connect().then(function(){d("bind on",b);g.prototype.on.call(m,b,a);m.message("_on").set("noRespond",!0).set("data",
{name:b,clientId:m.id}).send(m.port)});return this};c.prototype.off=function(b,a){var d=this;this.connect().then(function(){g.prototype.off.call(d,b,a);d.message("_off").set("noRespond",!0).set("data",{name:b,clientId:d.id}).send(d.port)});return this};e=c.prototype;e.destroy=e.destroy;e.plugin=e.plugin;e.method=e.method;e.connect=e.connect;e.disconnect=e.disconnect;e.on=e.on;e.off=e.off},{"./emitter":3,"./message":4,"./message/port-adaptors":5,"./utils":7}],3:[function(e,h,n){function c(e){if(e)return Object.assign(e,
c.prototype)}h.exports=c;c.prototype={on:function(c,e){this._callbacks||(this._callbacks={});this._callbacks[c]||(this._callbacks[c]=[]);this._callbacks[c].push(e);return this},off:function(c,e){if(this._callbacks)switch(arguments.length){case 0:this._callbacks={};break;case 1:delete this._callbacks[c];break;default:var g=this._callbacks[c];if(!g)return;var f=g.indexOf(e);~f&&g.splice(f,1)}return this},emit:function(c,e){if(this._callbacks)for(var g=this._callbacks[c]||[],g=g.concat(this._callbacks["*"]||
[]),f=0;f<g.length;f++)g[f].call(this,e,c);return this}};e=c.prototype;e.off=e.off;e.on=e.on},{}],4:[function(e,h,n){function c(a){this.cancelled=!1;this.listeners=[];this.deferred=k();this.onMessage=this.onMessage.bind(this);this.onTimeout=this.onTimeout.bind(this);"object"===typeof a?this.setupInbound(a):this.setupOutbound(a);b("initialized",a)}function l(a){this.name=a;this.ports=new Set;this.onMessage=this.onMessage.bind(this);this.listen=this.listen.bind(this);this.unlisten=this.unlisten.bind(this);
b("receiver initialized",a)}function p(a,b){b=[].slice.call(arguments,1);return Error({1:".send() can only be called once",2:"response already sent for this message",3:"a port must be defined",4:"timeout"}[a])}var g=e("./port-adaptors"),f=e("../emitter");e=e("../utils");var k=e.deferred,d=e.uuid;n=h.exports=function(a){return new c(a)};n.receiver=function(a,b){return new l(a,b)};n.Receiver=l;n.Message=c;var b={0:function(){},1:function(a){return performance.mark("["+self.constructor.name+"][Message] - "+
a)},2:function(a,b){b=[].slice.call(arguments,1);console.log.apply(console,[].concat(["[Message]"+("["+self.constructor.name+"]["+location.pathname+"]")+' - "'+a+'"'],b))}}[1];c.prototype={setupOutbound:function(a){this.id=d();this.type=a;this.sent=!1;this.recipient="*"},setupInbound:function(a){b("inbound");this.hasResponded=!1;this.setSourcePort(a.source||a.target);this.event=a;Object.assign(this,a.data)},setSourcePort:function(a){b("set source",a.constructor.name);this.sourcePort=g(a,{ready:!0});
return this},set:function(a,d){b("set",a,d);"object"==typeof a?Object.assign(this,a):this[a]=d;return this},serialize:function(){return{id:this.id,type:this.type,data:this.data,recipient:this.recipient,noRespond:this.noRespond}},preventDefault:function(){b("prevent default");this.defaultPrevented=!0},send:function(a){b("send",this.type);if(this.sent)throw p(1);var d=this.serialize(),c=!this.noRespond;this.port=a?g(a):this.port;if(!this.port)throw p(3);c?(this.listen(this.port),this.setResponseTimeout()):
this.deferred.resolve();this.port.postMessage(d,this.getTransfer());b("sent",d);return this.deferred.promise},setResponseTimeout:function(){!1!==this.timeout&&(this._timer=setTimeout(this.onTimeout,this.timeout||1E3))},clearResponseTimeout:function(){clearTimeout(this._timer)},getTransfer:function(){return this.transfer||this.event&&this.event.ports},onMessage:function(a){if(a.data.response&&a.data.id===this.id&&!this.cancelled)this.onResponse(a)},onTimeout:function(){b("response timeout",this.type);
this.silentTimeout||this.deferred.reject(p(4));this.teardown()},listen:function(a){b("add response listener",a);a=g(a);a.addListener(this.onMessage);this.listeners.push(a);return this},unlisten:function(){var a=this;b("remove response listeners");this.listeners.forEach(function(b){return b.removeListener(a.onMessage)});this.listeners=[]},cancel:function(){this.teardown();this.cancelled=!0;this.emit("cancel")},teardown:function(){this.clearResponseTimeout();this.unlisten()},respond:function(a){function d(a){b("resolve",
a);k({type:"resolve",value:a})}function c(a){a=a&&a.message||a;b("reject",a);k({type:"reject",value:a})}function k(a){e.response=a;e.sourcePort.postMessage({id:e.id,response:a},e.transfer);b("responded with:",a)}b("respond",a);if(this.hasResponded)throw p(2);if(this.sourcePort&&!this.noRespond){var e=this;this.hasResponded=!0;a instanceof Error&&c(a);Promise.resolve(a).then(d,c).catch(c)}},forward:function(a){var d=this;b("forward");return this.set("silentTimeout",!0).send(a).then(function(a){return d.respond(a.value)})},
onResponse:function(a){b("on response",a.data);var d=a.data.response,c="reject"==d.type?d.value:d;d.event=a;this.response=d;this.teardown();this.deferred[this.response.type](c);this.emit("response",d)}};f(c.prototype);l.prototype={listen:function(a){b("listen");a=g(a||self,{receiver:!0});if(!this.ports.has(a))return a.addListener(this.onMessage,this.listen),this.ports.add(a),this},unlisten:function(){var a=this;b("unlisten");this.ports.forEach(function(b){b.removeListener(a.onMessage,a.unlisten)})},
onMessage:function(a){if(a.data.id&&a.data.type&&this.isRecipient(a.data.recipient)&&(b("receiver on message",a.data),a=new c(a),this.emit("message",a),!a.defaultPrevented))try{this.emit(a.type,a)}catch(d){throw a.respond(d),d;}},isRecipient:function(a){return a==this.name||"*"==a||"*"==this.name},destroy:function(){this.unlisten();delete this.name;return this}};f(l.prototype)},{"../emitter":3,"../utils":7,"./port-adaptors":5}],5:[function(e,h,n){function c(d){this.target=d}function l(d,b,a){d.addEventListener(b,
a)}var p=e("../utils").deferred;h.exports=function(d,b){if(!d)throw Error({1:"target is undefined"}[1]);if(d&&d.addListener)return d;var a=f[d.constructor.name];return a?a(d,b):new c(d,b)};var g=c.prototype={constructor:c,addListener:function(d){this.target.addEventListener("message",d)},removeListener:function(d){this.target.removeEventListener("message",d)},postMessage:function(d,b){this.target.postMessage(d,b)}},f={HTMLIFrameElement:function(d){var b=k(d);return{addListener:function(a,b){window.addEventListener("message",
a)},removeListener:function(a,b){window.removeEventListener("message",a)},postMessage:function(a,c){b.then(function(){d.contentWindow.postMessage(a,"*",c)})}}},BroadcastChannel:function(d,b){function a(){var a=p();d.postMessage("ready?");l(d,"message",function q(b){"ready"==b.data&&(d.removeEventListener("message",q),a.resolve())});return a.promise}var c=b&&b.receiver,k=b&&b.ready,k=k||c?Promise.resolve():a();c&&(d.postMessage("ready"),l(d,"message",function(a){"ready?"==a.data&&d.postMessage("ready")}));
return{target:d,addListener:g.addListener,removeListener:g.removeListener,postMessage:function(a,b){k.then(function(){return d.postMessage(a,b)})}}},Window:function(d,b){var a=b&&b.ready||d===self,a=a?Promise.resolve():k(d);return{addListener:function(a,b){window.addEventListener("message",a)},removeListener:function(a,b){window.removeEventListener("message",a)},postMessage:function(b,c){a.then(function(){return d.postMessage(b,"*",c)})}}},SharedWorker:function(d){d.port.start();return new c(d.port)},
SharedWorkerGlobalScope:function(){var d=[];return{postMessage:function(){},addListener:function(b,a){this.onconnect=function(b){b=b.ports[0];d.push(b);b.start();a(b)};self.addEventListener("connect",this.onconnect)},removeListener:function(b,a){self.removeEventListener("connect",this.onconnect);d.forEach(function(b){b.close();a(b)})}}}},k=function(){if("undefined"!=typeof window){var d=window.opener||window.parent,b=new WeakSet;d!=self&&l(window,"DOMContentLoaded",function m(){window.removeEventListener("DOMContentLoaded",
m);d.postMessage("load","*")});l(self,"message",function(d){return"load"==d.data&&b.add(d.source)});return function(d){var c=d.contentWindow||d;if(b.has(c)||c==window.parent)return Promise.resolve();var k=p();l(window,"message",function q(b){"load"==b.data&&b.source==c&&(window.removeEventListener("message",q),k.resolve())});return k.promise}}}()},{"../utils":7}],6:[function(e,h,n){function c(k){if(!(this instanceof c))return new c(k);g.Receiver.call(this,k);this.clients={};this.methods={};this.on("_disconnect",
this.onDisconnect.bind(this)).on("_connect",this.onConnect.bind(this)).on("_method",this.onMethod.bind(this)).on("_off",this.onOff.bind(this)).on("_on",this.onOn.bind(this));this.destroy=this.destroy.bind(this);f("initialized",k,self.createEvent)}function l(c){var d=[].slice.call(arguments,1);return Error({4:'method "'+d[0]+"\" doesn't exist"}[c])}var p=e("./utils").uuid,g=e("./message");e=g.Receiver;h.exports=c;var f={0:function(){},1:function(c){return performance.mark("["+self.constructor.name+
"][Service] - "+c)},2:function(c,d){d=[].slice.call(arguments,1);console.log.apply(console,[].concat(["[Service]"+("["+self.constructor.name+"]["+location.pathname+"]")+' - "'+c+'"'],d))}}[1];c.prototype=Object.create(e.prototype);c.prototype.method=function(c,d){this.methods[c]=d;return this};c.prototype.broadcast=function(c,d,b){var a=this;f("broadcast",c,d,b);this.eachClient(function(e){if(!b||~b.indexOf(e.id))f("broadcasting to",e.id),a.push(c,d,e.id,{noRespond:!0})});return this};c.prototype.push=
function(c,d,b,a){a=a&&a.noRespond;var e=this.getClient(b);return g("_push").set({recipient:b,noRespond:a,data:{type:c,data:d}}).send(e.port)};c.prototype.eachClient=function(c){for(var d in this.clients)c(this.clients[d])};c.prototype.getClient=function(c){return this.clients[c]};c.prototype.onConnect=function(c){f("connection attempt",c.data,this.name);var d=c.data,b=d.clientId;if(b&&d.service===this.name&&!this.clients[b]&&(this.emit("before-connect",c),!c.defaultPrevented)){if(d=(d=c.event.ports)&&
d[0])c.setSourcePort(d),this.listen(d),d.start();this.addClient(b,c.sourcePort);c.respond();this.emit("connected",b);f("connected",b)}};c.prototype.onDisconnect=function(c){var d=this.clients[c.data];d&&(this.emit("before-disconnect",c),c.defaultPrevented||(this.removeClient(d.id),c.respond(),this.emit("disconnected",d.id),f("disconnected",d.id)))};c.prototype.onMethod=function(c){f("on method",c.data);this.emit("before-method",c);if(!c.defaultPrevented){var d=c.data,b=d.name,a,e=this.methods[b];
if(!e)throw l(4,b);try{a=e.apply(this,d.args)}catch(g){a=g}c.respond(a)}};c.prototype.onOn=function(c){f("on on",c.data);this.emit("on",c.data)};c.prototype.onOff=function(c){f("on off");this.emit("off",c.data)};c.prototype.addClient=function(c,d){this.clients[c]={id:c,port:d}};c.prototype.removeClient=function(c){delete this.clients[c]};c.prototype.plugin=function(c){c(this,{uuid:p});return this};c.prototype.disconnect=function(c){this.removeClient(c.id);g("disconnect").set({recipient:c.id,noRespond:!0}).send(c.port)};
c.prototype.destroy=function(){delete this.clients;this.unlisten();this.off()};h=c.prototype;h.broadcast=h.broadcast;h.destroy=h.destroy;h.method=h.method;h.plugin=h.plugin},{"./message":4,"./utils":7}],7:[function(e,h,n){n.uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var e=16*Math.random()|0;return("x"==c?e:e&3|8).toString(16)})};n.deferred=function(){var c={};c.promise=new Promise(function(e,h){c.resolve=e;c.reject=h});return c}},{}]},{},[1]);
